<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel - <%= username %>
  </title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Pƒ∞T10 G√ñREV Y√ñNETƒ∞Mƒ∞</h2>
        <p>
          <%= username %> (<%= role %>)
        </p>
      </div>
      <nav class="sidebar-menu">
        <a href="#" class="menu-item active" onclick="showSection('gorevler')">
          <span class="menu-item-icon">üìã</span>
          <span>G√∂revler</span>
        </a>
        <a href="/all-tasks" class="menu-item">
          <span class="menu-item-icon">üìä</span>
          <span>T√ºm G√∂revler</span>
        </a>

        <% if (role==='atayan' || role==='yonetici' ) { %>
          <a href="#" class="menu-item" onclick="showSection('yeni-gorev')">
            <span class="menu-item-icon">‚ûï</span>
            <span>Yeni G√∂rev</span>
          </a>
          <a href="#" class="menu-item" onclick="showSection('excel-yukle')">
            <span class="menu-item-icon">üìä</span>
            <span>Excel Y√ºkle</span>
          </a>
          <a href="/tebligatlar" class="menu-item">
            <span class="menu-item-icon">üìù</span>
            <span>Tebligatlar</span>
          </a>
          <% } %>
            <% if (role==='atayan' ) { %>
              <a href="#" class="menu-item" onclick="showSection('onay-bekleyen')">
                <span class="menu-item-icon">‚úÖ</span>
                <span>Son Onay</span>
              </a>
              <% } %>
                <% if (role==='yonetici' ) { %>
                  <a href="#" class="menu-item" onclick="showSection('bana-atanan')">
                    <span class="menu-item-icon">üìù</span>
                    <span>Bana Atanan</span>
                  </a>
                  <a href="#" class="menu-item" onclick="showSection('atama')">
                    <span class="menu-item-icon">üë•</span>
                    <span>Atama</span>
                  </a>
                  <a href="#" class="menu-item" onclick="showSection('kontrol')">
                    <span class="menu-item-icon">üîç</span>
                    <span>Kontrol</span>
                  </a>
                  <a href="#" class="menu-item" onclick="showSection('yonetici-onay')">
                    <span class="menu-item-icon">‚úÖ</span>
                    <span>Son Onay</span>
                  </a>
                  <a href="#" class="menu-item" onclick="showSection('adliye-listesi')">
                    <span class="menu-item-icon">üèõÔ∏è</span>
                    <span>Adliye Listesi</span>
                  </a>
                  <% } %>
                    <a href="#" class="menu-item" onclick="showSection('tebligat-olustur')">
                      <span class="menu-item-icon">üìù</span>
                      <span>Tebligat Olu≈ütur</span>
                    </a>
                    <a href="#" class="menu-item" onclick="showSection('tebligat-listesi')">
                      <span class="menu-item-icon">üìö</span>
                      <span>Tebligat Listesi</span>
                    </a>
                    <a href="/archive" class="menu-item">
                      <span class="menu-item-icon">üì¶</span>
                      <span>Ar≈üiv</span>
                    </a>
      </nav>
      <div class="sidebar-footer">
        <form method="GET" action="/logout">
          <button type="submit" class="logout-btn">√áƒ±kƒ±≈ü Yap</button>
        </form>
      </div>
    </aside>

    <main class="main-content">
      <div class="content-header">
        <h1>G√∂rev Y√∂netimi</h1>
        <p class="breadcrumb">Ana Sayfa / G√∂revler</p>
      </div>

      <!-- ƒ∞statistikler -->
      <div class="stats-grid">
        <% if (role==='atayan' ) { %>
          <div class="stat-card">
            <div class="stat-icon blue">üìä</div>
            <div class="stat-info">
              <h3>
                <%= stats.total || 0 %>
              </h3>
              <p>Toplam G√∂rev</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green">‚úÖ</div>
            <div class="stat-info">
              <h3>
                <%= stats.forApproval || 0 %>
              </h3>
              <p>Onay Bekleyen</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange">‚è≥</div>
            <div class="stat-info">
              <h3>
                <%= stats.active || 0 %>
              </h3>
              <p>Aktif G√∂rev</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple">üì¶</div>
            <div class="stat-info">
              <h3>
                <%= stats.archived || 0 %>
              </h3>
              <p>Ar≈üivlenen</p>
            </div>
          </div>
          <% } else if (role==='yonetici' ) { %>
            <div class="stat-card">
              <div class="stat-icon blue">üìä</div>
              <div class="stat-info">
                <h3>
                  <%= stats.total || 0 %>
                </h3>
                <p>Toplam G√∂rev</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon orange">üë•</div>
              <div class="stat-info">
                <h3>
                  <%= stats.toDistribute || 0 %>
                </h3>
                <p>Atama Bekleyen</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon purple">üîç</div>
              <div class="stat-info">
                <h3>
                  <%= stats.forControl || 0 %>
                </h3>
                <p>Kontrol Edilecek</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon green">üìù</div>
              <div class="stat-info">
                <h3>
                  <%= stats.myAssignedTasks || 0 %>
                </h3>
                <p>Bana Atanan</p>
              </div>
            </div>
            <% } else if (role==='atanan' ) { %>
              <div class="stat-card">
                <div class="stat-icon blue">üìä</div>
                <div class="stat-info">
                  <h3>
                    <%= stats.total || 0 %>
                  </h3>
                  <p>Toplam G√∂rev</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon orange">‚è≥</div>
                <div class="stat-info">
                  <h3>
                    <%= stats.pending || 0 %>
                  </h3>
                  <p>Bekleyen</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon purple">üîÑ</div>
                <div class="stat-info">
                  <h3>
                    <%= stats.inProgress || 0 %>
                  </h3>
                  <p>Devam Eden</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon green">‚úÖ</div>
                <div class="stat-info">
                  <h3>
                    <%= stats.completed || 0 %>
                  </h3>
                  <p>Tamamlanan</p>
                </div>
              </div>
              <% } %>
      </div>

      <!-- G√∂revler B√∂l√ºm√º -->
      <section id="gorevler" class="section active">
        <h2>
          <% if (role==='atayan' ) { %>Olu≈üturduƒüum G√∂revler<% } %>
              <% if (role==='yonetici' ) { %>T√ºm G√∂revler<% } %>
                  <% if (role==='atanan' ) { %>G√∂revlerim<% } %>
        </h2>

        <% let displayTasks=[]; if (role==='atayan' && tasks.myTasks) { displayTasks=tasks.myTasks; } else if
          (role==='yonetici' && tasks.toDistribute) { displayTasks=[...tasks.toDistribute, ...(tasks.forControl || [])];
          } else if (role==='atanan' && Array.isArray(tasks)) { displayTasks=tasks; } %>

          <% if (displayTasks.length> 0) { %>
            <% displayTasks.forEach(task=> { %>
              <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                <div class="task-header">
                  <div>
                    <h3>
                      <%= task.islem_turu || 'G√∂rev' %>
                    </h3>
                  </div>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                      <%= task.oncelik ? task.oncelik.toUpperCase() : 'RUTIN' %>
                    </span>
                    <% if ((role==='atayan' || role==='yonetici' ) && task.creator_id===userId) { %>
                      <form method="POST" action="/tasks/<%= task.id %>/delete" style="margin: 0;">
                        <button type="submit" class="delete-btn"
                          onclick="return confirm('Bu g√∂revi silmek istediƒüinizden emin misiniz?')"
                          title="G√∂revi Sil">üóëÔ∏è</button>
                      </form>
                      <% } %>
                  </div>
                </div>
                <p><strong>Adliye:</strong>
                  <%= task.adliye || '-' %> |
                    <strong>M√ºvekkil:</strong>
                    <%= task.muvekkil || '-' %> |
                      <strong>Portf√∂y:</strong>
                      <%= task.portfoy || '-' %>
                </p>
                <p><strong>ƒ∞cra Dairesi:</strong>
                  <%= task.icra_dairesi || '-' %>
                </p>
                <p><strong>Dosya No:</strong>
                  <%= task.icra_esas_no || '-' %>
                </p>
                <% if (task.borclu) { %>
                  <p><strong>Bor√ßlu:</strong>
                    <%= task.borclu %>
                  </p>
                  <% } %>
                    <% if (task.islem_aciklamasi) { %>
                      <p><strong>A√ßƒ±klama:</strong>
                        <%= task.islem_aciklamasi %>
                      </p>
                      <% } %>
                        <p><strong>Durum:</strong>
                          <%= task.status || 'tamamlanmadi' %>
                        </p>
                        <% if (task.eklenme_tarihi) { %>
                          <p><strong>Tarih:</strong>
                            <%= task.eklenme_tarihi %>
                          </p>
                          <% } %>

                            <% if (role==='atanan' ) { %>
                              <form method="POST" action="/tasks/<%= task.id %>/status" style="margin-top: 0.75rem;">
                                <input type="hidden" name="returnTo" value="bana-atanan">
                                <select name="status" required onchange="checkConfirm(this)"
                                  style="margin-bottom: 0.5rem;">
                                  <option value="">Durum Deƒüi≈ütir</option>
                                  <option value="tamamlanmadi" <%=task.status==='tamamlanmadi' ? 'selected' : '' %>
                                    >Tamamlanmadƒ±</option>
                                  <option value="kontrol_ediliyor" <%=task.status==='kontrol_ediliyor' ? 'selected' : ''
                                    %>>Kontrol Ediliyor</option>
                                  <option value="tamamlandi">Tamamlandƒ±</option>
                                  <option value="tamamlanamƒ±yor">Tamamlanamƒ±yor</option>
                                  <option value="iade" <%=task.status==='iade' ? 'selected' : '' %>>ƒ∞ade</option>
                                </select>
                                <button type="submit">G√ºncelle</button>
                              </form>
                              <!-- Notes UI -->
                              <div class="note-controls" style="margin-top:0.5rem;">
                                <button type="button" class="btn btn-note"
                                  onclick="toggleNotes('<%= task.id %>','gorevler')">üìù G√∂rev Notu (<%=
                                    ((historiesByTask && historiesByTask[task.id]) || []).filter(h=>
                                    h.action==='note').length %>)</button>
                              </div>
                              <div class="note-panel" id="notes-gorevler-<%= task.id %>"
                                style="display:none; margin-top:0.5rem;">
                                <div class="notes-list">
                                  <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                    h.action==='note' ; }).forEach(function(h){ %>
                                    <div class="note-item">
                                      <div class="note-meta"><strong>
                                          <%= users.find(function(u){ return u.id===h.user_id; })?.username || 'Anonim'
                                            %>
                                        </strong> ¬∑ <small>
                                          <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                        </small></div>
                                      <div class="note-body">
                                        <%= h.details %>
                                      </div>
                                    </div>
                                    <% }) %>
                                </div>
                                <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                  <input type="hidden" name="returnTo" value="gorevler">
                                  <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                  <button type="submit" class="btn btn-primary" style="margin-top:0.5rem;">Ekle</button>
                                </form>
                              </div>
                              <% } %>
              </div>
              <% }) %>
                <% } else { %>
                  <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>G√∂rev bulunamadƒ±</p>
                  </div>
                  <% } %>
      </section>

      <% if (role==='yonetici' ) { %>
        <!-- Adliye Listesi (Y√∂neticiler i√ßin) -->
        <section id="adliye-listesi" class="section">
          <h2>Adliye Listesi</h2>
          <div class="adliye-container">
            <aside class="adliye-sidebar">
              <h4 style="margin-bottom: 1rem; color: #2c3e50;">Adliyeler</h4>
              <% (adliyeler || []).forEach(function(a, idx){ %>
                <button type="button" onclick="showAdliye('<%= a %>')"
                  class="adliye-btn <%= idx === 0 ? 'active' : '' %>">
                  <span class="adliye-icon">üèõÔ∏è</span>
                  <span>
                    <%= a %>
                  </span>
                </button>
                <% }) %>
            </aside>
            <div class="adliye-content">
              <% (adliyeler || []).forEach(function(a, idx){ %>
                <div class="adliye-panel" id="adliye-<%= a %>" style="<%= idx === 0 ? '' : 'display:none;' %>">
                  <div class="adliye-header">
                    <h3>
                      <%= a %>
                    </h3>
                    <button type="button" onclick="copyTable('tbl-<%= a.replace(/\s+/g,'_') %>')" class="copy-btn">
                      üìã Tabloyu Kopyala
                    </button>
                  </div>
                  <div class="modern-table-wrapper">
                    <table id="tbl-<%= a.replace(/\s+/g,'_') %>" class="modern-table">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>ƒ∞≈ülem T√ºr√º</th>
                          <th>ƒ∞cra Dairesi</th>
                          <th>Dosya No</th>
                          <th>M√ºvekkil</th>
                          <th>Portf√∂y</th>
                          <th>Bor√ßlu</th>
                          <th>Durum</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% (tasksByAdliye[a] || []).forEach(function(t){ %>
                          <tr>
                            <td><span class="id-badge">#<%= t.id %></span></td>
                            <td><strong>
                                <%= t.islem_turu %>
                              </strong></td>
                            <td>
                              <%= t.icra_dairesi || '-' %>
                            </td>
                            <td><strong style="color: #667eea;">
                                <%= t.icra_esas_no || '-' %>
                              </strong></td>
                            <td>
                              <%= t.muvekkil %>
                            </td>
                            <td>
                              <%= t.portfoy %>
                            </td>
                            <td>
                              <%= t.borclu || '-' %>
                            </td>
                            <td><span class="status-badge status-<%= t.status %>">
                                <%= t.status %>
                              </span></td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <% }) %>
            </div>
          </div>
        </section>
        <% } %>





          <% if (role==='atayan' || role==='yonetici' ) { %>
            <!-- Yeni G√∂rev Olu≈ütur -->
            <section id="yeni-gorev" class="section">
              <h2>Yeni G√∂rev Olu≈ütur</h2>
              <form method="POST" action="/tasks/create" class="task-form">
                <input type="hidden" name="returnTo" value="yeni-gorev">

                <select name="muvekkil" required>
                  <option value="">M√ºvekkil Se√ßin *</option>
                  <option value="GSD">GSD</option>
                  <option value="Doƒüru">Doƒüru</option>
                  <option value="S√ºmer">S√ºmer</option>
                  <option value="Ulusal">Ulusal</option>
                  <option value="Birikim">Birikim</option>
                  <option value="Emir">Emir</option>
                  <option value="Birle≈üim">Birle≈üim</option>
                </select>

                <select name="portfoy" required>
                  <option value="">Portf√∂y Se√ßin *</option>
                  <option value="Fiba 01">Fiba 01</option>
                  <option value="Fiba 02">Fiba 02</option>
                  <option value="Fiba 03">Fiba 03</option>
                  <option value="Fiba 04">Fiba 04</option>
                  <option value="Anadolu">Anadolu</option>
                  <option value="YKB 01">YKB 01</option>
                  <option value="YKB 02">YKB 02</option>
                  <option value="YKB 03">YKB 03</option>
                  <option value="YKB 04">YKB 04</option>
                  <option value="ƒ∞≈übank Bireysel 01">ƒ∞≈übank Bireysel 01</option>
                  <option value="ƒ∞≈übank Bireysel 02">ƒ∞≈übank Bireysel 02</option>
                  <option value="ƒ∞≈übank 01">ƒ∞≈übank 01</option>
                  <option value="ƒ∞≈übank 02">ƒ∞≈übank 02</option>
                  <option value="ƒ∞≈übank 03">ƒ∞≈übank 03</option>
                  <option value="≈ûeker">≈ûeker</option>
                  <option value="Garantibank">Garantibank</option>
                  <option value="Garanti Fakt√∂ring">Garanti Fakt√∂ring</option>
                  <option value="ƒ∞NG">ƒ∞NG</option>
                </select>

                <input type="text" name="borclu" placeholder="Bor√ßlu">
                <input type="text" name="borclu_tckn_vkn" placeholder="Bor√ßlu TCKN-VKN">
                <input type="text" name="icra_dairesi" placeholder="ƒ∞cra Dairesi *" required>
                <input type="text" name="icra_esas_no" placeholder="ƒ∞cra Esas Numarasƒ±">

                <select name="islem_turu" required>
                  <option value="">ƒ∞≈ülem T√ºr√º Se√ßin *</option>
                  <option value="Kesinle≈ütirme Yapƒ±lacak">Kesinle≈ütirme Yapƒ±lacak</option>
                  <option value="Tebligat √áƒ±karƒ±lacak">Tebligat √áƒ±karƒ±lacak</option>
                  <option value="Ta≈üƒ±nmaz Haczi">Ta≈üƒ±nmaz Haczi</option>
                  <option value="Ara√ß Haczi">Ara√ß Haczi</option>
                  <option value="Dosya Yenileme">Dosya Yenileme</option>
                  <option value="Banka Blokesi">Banka Blokesi</option>
                  <option value="Maa≈ü Haczi">Maa≈ü Haczi</option>
                  <option value="Mazbatalar Taratƒ±lacak">Mazbatalar Taratƒ±lacak</option>
                  <option value="Vekil Kaydƒ±">Vekil Kaydƒ±</option>
                  <option value="ƒ∞ade ƒ∞stenecek">ƒ∞ade ƒ∞stenecek</option>
                  <option value="Rehin A√ßƒ±ƒüƒ± Belgesi Alƒ±nacak">Rehin A√ßƒ±ƒüƒ± Belgesi Alƒ±nacak</option>
                  <option value="Reddiyat Yapƒ±lacak">Reddiyat Yapƒ±lacak</option>
                  <option value="Takip Ba≈ülatƒ±lacak">Takip Ba≈ülatƒ±lacak</option>
                  <option value="Eksik Evraklar Taratƒ±lacak">Eksik Evraklar Taratƒ±lacak</option>
                  <option value="Tebliagata Yarar Adres ƒ∞stenecek">Tebliagata Yarar Adres ƒ∞stenecek</option>
                  <option value="Bor√ßlu Bilgileri Eklenecek">Bor√ßlu Bilgileri Eklenecek</option>
                  <option value="Kuruma 89/1 G√∂nderilecek">Kuruma 89/1 G√∂nderilecek</option>
                  <option value="Taraf Kaydƒ± D√ºzeltilecek">Taraf Kaydƒ± D√ºzeltilecek</option>
                  <option value="Yeni Esas Alƒ±nacak">Yeni Esas Alƒ±nacak</option>
                  <option value="√ñdeme Emri D√ºzenlenecek">√ñdeme Emri D√ºzenlenecek</option>
                  <option value="Bor√ßlu Eklenecek">Bor√ßlu Eklenecek</option>
                  <option value="Alacaklƒ± olduƒüu icra dosyasƒ±na haciz konulacak">Alacaklƒ± olduƒüu icra dosyasƒ±na
                    haciz
                    konulacak</option>
                </select>

                <textarea name="islem_aciklamasi" placeholder="ƒ∞≈ülem A√ßƒ±klamasƒ± *" required></textarea>

                <select name="oncelik" required>
                  <option value="rutin">Rutin</option>
                  <option value="acil">Acil</option>
                </select>

                <input type="date" name="eklenme_tarihi" value="<%= new Date().toISOString().split('T')[0] %>">

                <button type="submit">G√∂rev Olu≈ütur</button>
              </form>
            </section>

            <!-- Excel Y√ºkle -->
            <section id="excel-yukle" class="section">
              <h2>Excel'den Toplu Y√ºkle</h2>
              <div style="margin-bottom: 1.5rem;">
                <a href="/download-template" class="download-btn">üì• Excel ≈ûablonu ƒ∞ndir</a>
              </div>
              <form method="POST" action="/upload-excel" enctype="multipart/form-data" class="task-form">
                <input type="file" name="excelFile" accept=".xlsx,.xls" required>
                <button type="submit">Excel Y√ºkle</button>
              </form>
              <p class="info">Kolonlar: M√ºvekkil, Portf√∂y, Bor√ßlu, Bor√ßlu TCKN-VKN, ƒ∞cra Dairesi, ƒ∞cra Esas
                Numarasƒ±,
                ƒ∞≈ûLEM T√úR√ú, ƒ∞≈ülem A√áIKLAMASI, √ñNCELƒ∞K, Eklenme Tarihi</p>
            </section>
            <% } %>

              <% if (role==='atayan' ) { %>
                <!-- Son Onay Bekleyen -->
                <section id="onay-bekleyen" class="section">
                  <h2>Son Onay Bekleyen G√∂revler</h2>
                  <% if (tasks.forApproval && tasks.forApproval.length> 0) { %>
                    <% tasks.forApproval.forEach(task=> { %>
                      <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                        <div class="task-header">
                          <h3>
                            <%= task.islem_turu %>
                          </h3>
                          <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                            <%= task.oncelik.toUpperCase() %>
                          </span>
                        </div>
                        <p><strong>Adliye:</strong>
                          <%= task.adliye %> | <strong>M√ºvekkil:</strong>
                            <%= task.muvekkil %> | <strong>Portf√∂y:</strong>
                              <%= task.portfoy %>
                        </p>
                        <p><strong>ƒ∞cra Dairesi:</strong>
                          <%= task.icra_dairesi || '-' %>
                        </p>
                        <p><strong>Dosya No:</strong>
                          <%= task.icra_esas_no || '-' %>
                        </p>
                        <% if (task.borclu) { %>
                          <p><strong>Bor√ßlu:</strong>
                            <%= task.borclu %>
                          </p>
                          <% } %>
                            <p><strong>A√ßƒ±klama:</strong>
                              <%= task.islem_aciklamasi %>
                            </p>
                            <% if (task.assignee_id) { %>
                              <p><strong>Atanan:</strong>
                                <%= users.find(u=> u.id === task.assignee_id)?.username || '-' %>
                              </p>
                              <% } %>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                                  <form method="POST" action="/tasks/<%= task.id %>/final-approve"
                                    style="display:inline; margin: 0;">
                                    <input type="hidden" name="returnTo" value="onay-bekleyen">
                                    <button type="submit" class="btn-approve"
                                      onclick="return confirm('G√∂revi onaylayƒ±p ar≈üivlemek istediƒüinizden emin misiniz?')">‚úÖ
                                      Son Onay Ver</button>
                                  </form>
                                  <form method="POST" action="/tasks/<%= task.id %>/control"
                                    style="display:inline; margin: 0;">
                                    <input type="hidden" name="returnTo" value="onay-bekleyen">
                                    <input type="hidden" name="control_status" value="iade">
                                    <button type="submit" class="btn-return"
                                      onclick="return confirm('G√∂revi atanana iade etmek istediƒüinizden emin misiniz?')">‚Ü©Ô∏è
                                      ƒ∞ade Et</button>
                                  </form>
                                </div>
                                <!-- Notes UI -->
                                <div class="note-controls" style="margin-top:0.5rem;">
                                  <button type="button" class="btn btn-note"
                                    onclick="toggleNotes('<%= task.id %>','onay-bekleyen')">üìù G√∂rev Notu (<%=
                                      ((historiesByTask && historiesByTask[task.id]) || []).filter(h=>
                                      h.action==='note').length %>)</button>
                                </div>
                                <div class="note-panel" id="notes-onay-bekleyen-<%= task.id %>"
                                  style="display:none; margin-top:0.5rem;">
                                  <div class="notes-list">
                                    <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                      h.action==='note' ; }).forEach(function(h){ %>
                                      <div class="note-item">
                                        <div class="note-meta"><strong>
                                            <%= users.find(function(u){ return u.id===h.user_id; })?.username
                                              || 'Anonim' %>
                                          </strong> ¬∑ <small>
                                            <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                          </small></div>
                                        <div class="note-body">
                                          <%= h.details %>
                                        </div>
                                      </div>
                                      <% }) %>
                                  </div>
                                  <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                    <input type="hidden" name="returnTo" value="onay-bekleyen">
                                    <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                    <button type="submit" class="btn btn-primary"
                                      style="margin-top:0.5rem;">Ekle</button>
                                  </form>
                                </div>
                      </div>
                      <% }) %>
                        <% } else { %>
                          <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>Onay bekleyen g√∂rev yok</p>
                          </div>
                          <% } %>
                </section>
                <% } %>

                  <% if (role==='yonetici' ) { %>
                    <!-- Bana Atanan G√∂revler -->
                    <section id="bana-atanan" class="section">
                      <h2>Bana Atanan G√∂revler (<%= tasks.myAssignedTasks ? tasks.myAssignedTasks.length : 0 %>)
                      </h2>
                      <% if (tasks.myAssignedTasks && tasks.myAssignedTasks.length> 0) { %>
                        <% tasks.myAssignedTasks.forEach(task=> { %>
                          <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                            <div class="task-header">
                              <h3>
                                <%= task.islem_turu %>
                              </h3>
                              <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                                <%= task.oncelik.toUpperCase() %>
                              </span>
                            </div>
                            <p><strong>Adliye:</strong>
                              <%= task.adliye %> | <strong>M√ºvekkil:</strong>
                                <%= task.muvekkil %> | <strong>Portf√∂y:</strong>
                                  <%= task.portfoy %>
                            </p>
                            <p><strong>ƒ∞cra Dairesi:</strong>
                              <%= task.icra_dairesi || '-' %>
                            </p>
                            <p><strong>Dosya No:</strong>
                              <%= task.icra_esas_no || '-' %>
                            </p>
                            <% if (task.borclu) { %>
                              <p><strong>Bor√ßlu:</strong>
                                <%= task.borclu %>
                              </p>
                              <% } %>
                                <p><strong>A√ßƒ±klama:</strong>
                                  <%= task.islem_aciklamasi %>
                                </p>
                                <p><strong>Durum:</strong>
                                  <%= task.status %>
                                </p>
                                <p><strong>Tarih:</strong>
                                  <%= task.eklenme_tarihi %>
                                </p>
                                <form method="POST" action="/tasks/<%= task.id %>/status" style="margin-top: 0.75rem;">
                                  <input type="hidden" name="returnTo" value="gorevler">
                                  <select name="status" required onchange="checkConfirm(this)"
                                    style="margin-bottom: 0.5rem;">
                                    <option value="">Durum Deƒüi≈ütir</option>
                                    <option value="tamamlanmadi" <%=task.status==='tamamlanmadi' ? 'selected' : '' %>
                                      >Tamamlanmadƒ±</option>
                                    <option value="kontrol_ediliyor" <%=task.status==='kontrol_ediliyor' ? 'selected'
                                      : '' %>>Kontrol Ediliyor</option>
                                    <option value="tamamlandi">Tamamlandƒ±</option>
                                    <option value="tamamlanamƒ±yor">Tamamlanamƒ±yor</option>
                                    <option value="iade" <%=task.status==='iade' ? 'selected' : '' %>>ƒ∞ade</option>
                                  </select>
                                  <button type="submit">G√ºncelle</button>
                                </form>
                                <!-- Notes UI -->
                                <div class="note-controls" style="margin-top:0.5rem;">
                                  <button type="button" class="btn btn-note"
                                    onclick="toggleNotes('<%= task.id %>','bana-atanan')">üìù G√∂rev Notu (<%=
                                      ((historiesByTask && historiesByTask[task.id]) || []).filter(h=>
                                      h.action==='note').length %>)</button>
                                </div>
                                <div class="note-panel" id="notes-bana-atanan-<%= task.id %>"
                                  style="display:none; margin-top:0.5rem;">
                                  <div class="notes-list">
                                    <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                      h.action==='note' ; }).forEach(function(h){ %>
                                      <div class="note-item">
                                        <div class="note-meta"><strong>
                                            <%= users.find(function(u){ return u.id===h.user_id; })?.username
                                              || 'Anonim' %>
                                          </strong> ¬∑ <small>
                                            <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                          </small></div>
                                        <div class="note-body">
                                          <%= h.details %>
                                        </div>
                                      </div>
                                      <% }) %>
                                  </div>
                                  <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                    <input type="hidden" name="returnTo" value="bana-atanan">
                                    <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                    <button type="submit" class="btn btn-primary"
                                      style="margin-top:0.5rem;">Ekle</button>
                                  </form>
                                </div>

                          </div>
                          <% }) %>
                            <% } else { %>
                              <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>Size atanan g√∂rev yok</p>
                              </div>
                              <% } %>
                    </section>

                    <!-- Atama Bekleyen -->
                    <section id="atama" class="section">
                      <h2>Atama Bekleyen G√∂revler</h2>
                      <% if (tasks.toDistribute && tasks.toDistribute.length> 0) { %>
                        <% tasks.toDistribute.forEach(task=> { %>
                          <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                            <div class="task-header">
                              <h3>
                                <%= task.islem_turu %>
                              </h3>
                              <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                                <%= task.oncelik.toUpperCase() %>
                              </span>
                            </div>
                            <p><strong>Adliye:</strong>
                              <%= task.adliye %> | <strong>M√ºvekkil:</strong>
                                <%= task.muvekkil %> | <strong>Portf√∂y:</strong>
                                  <%= task.portfoy %>
                            </p>
                            <p><strong>ƒ∞cra Dairesi:</strong>
                              <%= task.icra_dairesi || '-' %>
                            </p>
                            <p><strong>Dosya No:</strong>
                              <%= task.icra_esas_no || '-' %>
                            </p>
                            <p><strong>A√ßƒ±klama:</strong>
                              <%= task.islem_aciklamasi %>
                            </p>
                            <form method="POST" action="/tasks/<%= task.id %>/assign">
                              <input type="hidden" name="returnTo" value="atama">
                              <select name="assignee_id" required>
                                <option value="">Atanan Se√ß</option>
                                <% users.filter(u=> u.role === 'atanan' || u.role === 'yonetici').forEach(user => {
                                  %>
                                  <option value="<%= user.id %>">
                                    <%= user.username %>
                                  </option>
                                  <% }) %>
                              </select>
                              <button type="submit">Ata</button>
                            </form>
                            <!-- Notes UI -->
                            <div class="note-controls" style="margin-top:0.5rem;">
                              <button type="button" class="btn btn-note"
                                onclick="toggleNotes('<%= task.id %>','atama')">üìù
                                G√∂rev Notu (<%= ((historiesByTask && historiesByTask[task.id]) || []).filter(h=>
                                  h.action==='note').length %>)</button>
                            </div>
                            <div class="note-panel" id="notes-atama-<%= task.id %>"
                              style="display:none; margin-top:0.5rem;">
                              <div class="notes-list">
                                <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                  h.action==='note' ; }).forEach(function(h){ %>
                                  <div class="note-item">
                                    <div class="note-meta"><strong>
                                        <%= users.find(function(u){ return u.id===h.user_id; })?.username || 'Anonim' %>
                                      </strong> ¬∑ <small>
                                        <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                      </small></div>
                                    <div class="note-body">
                                      <%= h.details %>
                                    </div>
                                  </div>
                                  <% }) %>
                              </div>
                              <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                <input type="hidden" name="returnTo" value="atama">
                                <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                <button type="submit" class="btn btn-primary" style="margin-top:0.5rem;">Ekle</button>
                              </form>
                            </div>
                          </div>
                          <% }) %>
                            <% } else { %>
                              <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <p>Atama bekleyen g√∂rev yok</p>
                              </div>
                              <% } %>
                    </section>

                    <!-- Kontrol Edilecek -->
                    <section id="kontrol" class="section">
                      <h2>Kontrol Edilecek G√∂revler</h2>
                      <% if (tasks.forControl && tasks.forControl.length> 0) { %>
                        <% tasks.forControl.forEach(task=> { %>
                          <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                            <div class="task-header">
                              <h3>
                                <%= task.islem_turu %>
                              </h3>
                              <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                                <%= task.oncelik.toUpperCase() %>
                              </span>
                            </div>
                            <p><strong>Adliye:</strong>
                              <%= task.adliye %> | <strong>M√ºvekkil:</strong>
                                <%= task.muvekkil %> | <strong>Portf√∂y:</strong>
                                  <%= task.portfoy %>
                            </p>
                            <p><strong>ƒ∞cra Dairesi:</strong>
                              <%= task.icra_dairesi %>
                            </p>
                            <p><strong>A√ßƒ±klama:</strong>
                              <%= task.islem_aciklamasi %>
                            </p>
                            <p><strong>Atanan:</strong>
                              <%= users.find(u=> u.id === task.assignee_id)?.username || (task.assignee_id || '-')
                                %>
                            </p>
                            <p><strong>Durum:</strong>
                              <%= task.status %>
                            </p>
                            <div>
                              <% if (task.status==='kontrol_bekleniyor' || task.status==='son_onay_bekliyor' ) { %>
                                <form method="POST" action="/tasks/<%= task.id %>/control"
                                  style="display:inline; margin-right:0.5rem;">
                                  <input type="hidden" name="returnTo" value="kontrol">
                                  <input type="hidden" name="control_status" value="uygun">
                                  <button type="submit">Onay</button>
                                </form>
                                <form method="POST" action="/tasks/<%= task.id %>/control" style="display:inline;">
                                  <input type="hidden" name="returnTo" value="kontrol">
                                  <input type="hidden" name="control_status" value="iade">
                                  <button type="submit"
                                    onclick="return confirm('G√∂revi iade etmek istediƒüinize emin misiniz?')">ƒ∞ade</button>
                                </form>
                                <% } else { %>
                                  <form method="POST" action="/tasks/<%= task.id %>/control">
                                    <input type="hidden" name="returnTo" value="kontrol">
                                    <select name="control_status" required>
                                      <option value="">Kontrol Sonucu</option>
                                      <option value="kontrol_bekleniyor">Kontrol Bekleniyor</option>
                                      <option value="uygun">Uygun</option>
                                      <option value="iade">ƒ∞ade</option>
                                    </select>
                                    <button type="submit">Kaydet</button>
                                  </form>
                                  <% } %>
                            </div>
                            <!-- Notes UI -->
                            <div class="note-controls" style="margin-top:0.5rem;">
                              <button type="button" class="btn btn-note"
                                onclick="toggleNotes('<%= task.id %>','kontrol')">üìù G√∂rev Notu (<%= ((historiesByTask
                                  && historiesByTask[task.id]) || []).filter(h=>
                                  h.action==='note').length %>)</button>
                            </div>
                            <div class="note-panel" id="notes-kontrol-<%= task.id %>"
                              style="display:none; margin-top:0.5rem;">
                              <div class="notes-list">
                                <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                  h.action==='note' ; }).forEach(function(h){ %>
                                  <div class="note-item">
                                    <div class="note-meta"><strong>
                                        <%= users.find(function(u){ return u.id===h.user_id; })?.username || 'Anonim' %>
                                      </strong> ¬∑ <small>
                                        <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                      </small></div>
                                    <div class="note-body">
                                      <%= h.details %>
                                    </div>
                                  </div>
                                  <% }) %>
                              </div>
                              <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                <button type="submit" class="btn btn-primary" style="margin-top:0.5rem;">Ekle</button>
                              </form>
                            </div>
                          </div>
                          <% }) %>
                            <% } else { %>
                              <div class="empty-state">
                                <div class="empty-state-icon">üîç</div>
                                <p>Kontrol edilecek g√∂rev yok</p>
                              </div>
                              <% } %>
                    </section>

                    <!-- Y√∂netici Son Onay -->
                    <section id="yonetici-onay" class="section">
                      <h2>Son Onay Bekleyen G√∂revler (<%= tasks.forFinalApproval ? tasks.forFinalApproval.length : 0 %>)
                      </h2>
                      <% if (tasks.forFinalApproval && tasks.forFinalApproval.length> 0) { %>
                        <% tasks.forFinalApproval.forEach(task=> { %>
                          <div class="task-card <%= task.oncelik === 'acil' ? 'urgent' : '' %>">
                            <div class="task-header">
                              <h3>
                                <%= task.islem_turu %>
                              </h3>
                              <span class="badge <%= task.oncelik === 'acil' ? 'badge-urgent' : 'badge-normal' %>">
                                <%= task.oncelik.toUpperCase() %>
                              </span>
                            </div>
                            <p><strong>Adliye:</strong>
                              <%= task.adliye %> | <strong>M√ºvekkil:</strong>
                                <%= task.muvekkil %> | <strong>Portf√∂y:</strong>
                                  <%= task.portfoy %>
                            </p>
                            <p><strong>ƒ∞cra Dairesi:</strong>
                              <%= task.icra_dairesi || '-' %>
                            </p>
                            <p><strong>Dosya No:</strong>
                              <%= task.icra_esas_no || '-' %>
                            </p>
                            <% if (task.borclu) { %>
                              <p><strong>Bor√ßlu:</strong>
                                <%= task.borclu %>
                              </p>
                              <% } %>
                                <p><strong>A√ßƒ±klama:</strong>
                                  <%= task.islem_aciklamasi %>
                                </p>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                                  <form method="POST" action="/tasks/<%= task.id %>/final-approve"
                                    style="display:inline; margin: 0;">
                                    <input type="hidden" name="returnTo" value="yonetici-onay">
                                    <button type="submit" class="btn-approve"
                                      onclick="return confirm('G√∂revi onaylayƒ±p ar≈üivlemek istediƒüinizden emin misiniz?')">‚úÖ
                                      Son Onay Ver</button>
                                  </form>
                                  <form method="POST" action="/tasks/<%= task.id %>/control"
                                    style="display:inline; margin: 0;">
                                    <input type="hidden" name="returnTo" value="yonetici-onay">
                                    <input type="hidden" name="control_status" value="iade">
                                    <button type="submit" class="btn-return"
                                      onclick="return confirm('G√∂revi atanana iade etmek istediƒüinizden emin misiniz?')">‚Ü©Ô∏è
                                      ƒ∞ade Et</button>
                                  </form>
                                </div>
                                <!-- Notes UI -->
                                <div class="note-controls" style="margin-top:0.5rem;">
                                  <button type="button" class="btn btn-note"
                                    onclick="toggleNotes('<%= task.id %>','yonetici-onay')">üìù G√∂rev Notu (<%=
                                      ((historiesByTask && historiesByTask[task.id]) || []).filter(h=>
                                      h.action==='note').length %>)</button>
                                </div>
                                <div class="note-panel" id="notes-yonetici-onay-<%= task.id %>"
                                  style="display:none; margin-top:0.5rem;">
                                  <div class="notes-list">
                                    <% ((historiesByTask && historiesByTask[task.id]) || []).filter(function(h){ return
                                      h.action==='note' ; }).forEach(function(h){ %>
                                      <div class="note-item">
                                        <div class="note-meta"><strong>
                                            <%= users.find(function(u){ return u.id===h.user_id; })?.username
                                              || 'Anonim' %>
                                          </strong> ¬∑ <small>
                                            <%= new Date(h.created_at).toLocaleString('tr-TR') %>
                                          </small></div>
                                        <div class="note-body">
                                          <%= h.details %>
                                        </div>
                                      </div>
                                      <% }) %>
                                  </div>
                                  <form method="POST" action="/tasks/<%= task.id %>/note" class="note-form">
                                    <textarea name="note" placeholder="Not ekleyin..." required></textarea>
                                    <button type="submit" class="btn btn-primary"
                                      style="margin-top:0.5rem;">Ekle</button>
                                  </form>
                                </div>
                          </div>
                          <% }) %>
                            <% } else { %>
                              <div class="empty-state">
                                <div class="empty-state-icon">‚úÖ</div>
                                <p>Son onay bekleyen g√∂rev yok</p>
                              </div>
                              <% } %>
                    </section>
                    <% } %>



    </main>
  </div>

  <script>
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

      const section = document.getElementById(sectionId);
      if (section) section.classList.add('active');

      // Mark corresponding menu item active. If called from click, use event; otherwise try to match onclick attribute.
      try {
        if (typeof event !== 'undefined' && event && event.target) {
          const menu = event.target.closest('.menu-item');
          if (menu) menu.classList.add('active');
        } else {
          const menu = document.querySelector('.menu-item[onclick*="' + sectionId + '"]');
          if (menu) menu.classList.add('active');
        }
      } catch (e) {
        // ignore
      }
    }

    function checkConfirm(select) {
      const val = select.value;
      if (val === 'tamamlandi' || val === 'tamamlanamƒ±yor') {
        if (!confirm('Bu durumu se√ßtiƒüinizde g√∂rev y√∂neticiye g√∂nderilecek. Emin misiniz?')) {
          select.value = '';
        }
      }
    }
    function toggleNotes(id, section) {
      let el;
      if (section) el = document.getElementById('notes-' + section + '-' + id);
      if (!el) el = document.getElementById('notes-' + id); // fallback for older IDs
      if (!el) return;
      if (el.style.display === 'none' || el.style.display === '') el.style.display = 'block';
      else el.style.display = 'none';
    }
    function showAdliye(name) {
      document.querySelectorAll('.adliye-panel').forEach(p => p.style.display = 'none');
      document.querySelectorAll('.adliye-btn').forEach(b => b.classList.remove('active'));
      try {
        const el = document.getElementById('adliye-' + name);
        if (el) el.style.display = 'block';
        if (typeof event !== 'undefined' && event && event.target) {
          const btn = event.target.closest('.adliye-btn');
          if (btn) btn.classList.add('active');
        }
      } catch (e) { }
    }
    function copyTable(id) {
      try {
        const tbl = document.getElementById(id);
        if (!tbl) return alert('Tablo bulunamadƒ±');
        let text = '';
        for (let r of tbl.rows) {
          const cells = Array.from(r.cells).map(c => c.innerText.trim().replace(/\t/g, ' '));
          text += cells.join('\t') + '\n';
        }
        navigator.clipboard.writeText(text).then(() => alert('Tablo kopyalandƒ±'));
      } catch (e) { alert('Kopyalama desteklenmiyor: ' + e.message); }
    }
    // No client-side debug code; uploads use normal form POST.
    // On load, open server-provided active section (from session) or ?active= query
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const serverActive = "<%= active || '' %>";
        if (serverActive) {
          showSection(serverActive);
          return;
        }
        const params = new URLSearchParams(window.location.search);
        const active = params.get('active');
        if (active) showSection(active);
      } catch (e) { }
    });

  </script>
</body>

</html>